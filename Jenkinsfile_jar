podTemplate(label: 'mypod', containers: [
    containerTemplate(name: 'docker', image: 'docker', ttyEnabled: true, command: 'cat'),
    containerTemplate(name: 'maven', image: 'emtrout/dind:latest', command: 'cat', ttyEnabled: true)
  ],
  volumes: [
    hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock'),
  ]) {
    node('mypod') {


        String GIT_SHORT_COMMIT

        stage ('GIT Checkout') {
            git branch: "master", url: 'https://github.com/emichaf/eiffel-intelligence-artifact-wrapper.git'

            GIT_SHORT_COMMIT = sh(returnStdout: true, script: "git log -n 1 --pretty=format:'%h'").trim()


        }

        stage('Maven Build') {
            container('maven') {
            withCredentials([[$class: 'UsernamePasswordMultiBinding',
                        credentialsId: 'e7de4146-4a59-4406-916e-d10506cfaeb8',
                        usernameVariable: 'DOCKER_HUB_USER',
                        passwordVariable: 'DOCKER_HUB_PASSWORD']]) {


             sh "mvn clean package -DskipTests"

             }

            }
        }


        stage ('Test') {
        container('maven') {
              parallel (
                'Test Server' : {
                  sh 'ls'
                },
                'Test Sample Client' : {
                  sh 'ls'
                }
              )
            }
        }



        stage('Build and Push Docker Image') {
            container('docker') {
            withCredentials([[$class: 'UsernamePasswordMultiBinding',
                        credentialsId: 'e7de4146-4a59-4406-916e-d10506cfaeb8',
                        usernameVariable: 'DOCKER_HUB_USER',
                        passwordVariable: 'DOCKER_HUB_PASSWORD']]) {


               pom = readMavenPom file: 'pom.xml'

               sh "docker login -u ${env.DOCKER_HUB_USER} -p ${env.DOCKER_HUB_PASSWORD}"

               sh "docker build --no-cache=true -t ${env.DOCKER_HUB_USER}/${pom.artifactId}:latest -f src/main/docker/Dockerfile src/main/docker/"

               sh "docker push ${env.DOCKER_HUB_USER}/${pom.artifactId}:latest"

               sh "docker build --no-cache=true -t ${env.DOCKER_HUB_USER}/${pom.artifactId}:${GIT_SHORT_COMMIT} -f src/main/docker/Dockerfile src/main/docker/"

               sh "docker push ${env.DOCKER_HUB_USER}/${pom.artifactId}:${GIT_SHORT_COMMIT}"

               sh "docker logout"

               }
            }
        }







    }
}